name: Bootstrap Selfcheck

on:
  push:
    paths:
      - "bootstrap/**"
      - "bin/ralf"
      - "ralf"
      - "profiles/**"
      - "conventions/**"
      - ".github/workflows/bootstrap-selfcheck.yml"
  pull_request:
    paths:
      - "bootstrap/**"
      - "bin/ralf"
      - "ralf"
      - "profiles/**"
      - "conventions/**"
      - ".github/workflows/bootstrap-selfcheck.yml"
  workflow_dispatch:

jobs:
  bootstrap-selfcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Syntax checks
        run: |
          set -euo pipefail
          bash -n bootstrap/start.sh
          bash -n bin/ralf
          bash -n ralf
          bash -n bootstrap/legacy/start_host.sh
          bash -n bootstrap/legacy/start_lxd.sh
          bash -n bootstrap/release/sign-start.sh
          bash -n bootstrap/release/verify-start.sh
          bash -n bootstrap/release/print-start-integrity.sh
          bash -n bootstrap/selfcheck.sh

      - name: Local selfcheck script (quick)
        run: |
          set -euo pipefail
          chmod +x bootstrap/selfcheck.sh
          bash bootstrap/selfcheck.sh --quick

      - name: CLI selfcheck (host/lxd)
        run: |
          set -euo pipefail
          ./ralf bootstrap --provisioner host --outputs-dir /tmp/ralf-host-noapply >/dev/null || test $? -eq 1
          ./ralf bootstrap --provisioner host --apply --yes --outputs-dir /tmp/ralf-host-apply >/dev/null
          TUI=1 NON_INTERACTIVE=1 ./ralf bootstrap --provisioner host --outputs-dir /tmp/ralf-host-tui-ni >/dev/null || test $? -eq 1
          ./ralf bootstrap --provisioner host --answers-file bootstrap/examples/answers.generic_home.yml --outputs-dir /tmp/ralf-host-answers >/dev/null || test $? -eq 1
          ./ralf bootstrap --provisioner lxd --outputs-dir /tmp/ralf-lxd-noapply >/dev/null || test $? -eq 1
          ./ralf bootstrap --provisioner lxd --apply --outputs-dir /tmp/ralf-lxd-apply >/dev/null || test $? -eq 2

          python3 - <<'PY'
          import json
          checks = {
              "host_noapply": ("/tmp/ralf-host-noapply/cli_status.json", "warn", False),
              "host_apply": ("/tmp/ralf-host-apply/cli_status.json", "ok", True),
              "lxd_noapply": ("/tmp/ralf-lxd-noapply/cli_status.json", "warn", False),
              "lxd_apply": ("/tmp/ralf-lxd-apply/cli_status.json", "blocker", True),
          }
          for name, (path, expected_status, expected_report_exists) in checks.items():
              d = json.load(open(path))
              assert d["status"] == expected_status, (name, d["status"], expected_status)
              assert d["adapter_report_exists"] == expected_report_exists, (name, d["adapter_report_exists"], expected_report_exists)

          tui_cfg = json.load(open("/tmp/ralf-host-tui-ni/final_config.json"))
          tui_status = json.load(open("/tmp/ralf-host-tui-ni/cli_status.json"))
          assert tui_cfg["tui_requested"] == 1 and tui_cfg["tui"] == 0 and tui_cfg["non_interactive"] == 1
          assert tui_status["tui_requested"] == 1 and tui_status["tui_effective"] == 0
          assert any("disables TUI" in w for w in tui_status["warnings"])

          answers_cfg = json.load(open("/tmp/ralf-host-answers/final_config.json"))
          assert answers_cfg["network_cidr"] == "192.168.178.0/24"
          assert answers_cfg["base_domain"] == "home.lan"
          assert answers_cfg["ct_hostname"] == "ralf-bootstrap"
          print("bootstrap cli selfcheck ok")
          PY

      - name: Integrity helper selfcheck
        run: |
          set -euo pipefail
          bash bootstrap/release/print-start-integrity.sh --commit HEAD > /tmp/ralf-start-integrity.txt
          bash bootstrap/release/print-start-integrity.sh --json > /tmp/ralf-start-integrity.json
          grep -q '^COMMIT=' /tmp/ralf-start-integrity.txt
          grep -q '^SHA256=' /tmp/ralf-start-integrity.txt
          python3 - <<'PY'
          import json
          d = json.load(open("/tmp/ralf-start-integrity.json"))
          assert len(d["commit"]) == 40, d
          assert d["file"] == "bootstrap/start.sh", d
          assert len(d["sha256"]) == 64, d
          print("integrity helper selfcheck ok")
          PY

      - name: Launcher selfcheck (host)
        run: |
          set -euo pipefail
          ref="$(git rev-parse --short HEAD)"
          out=/tmp/ralf-launch-selfcheck
          rm -rf "$out"
          OUTPUTS_DIR="$out" PROVISIONER=host YES=1 APPLY=1 \
            RALF_REPO_URL="file://${GITHUB_WORKSPACE}" RALF_REF="$ref" \
            bash bootstrap/start.sh >/dev/null

          python3 - <<'PY'
          import json
          d = json.load(open("/tmp/ralf-launch-selfcheck/cli_status.json"))
          assert d["status"] == "ok", d
          assert d["adapter_report_exists"] is True, d
          assert len(d.get("adapter_artifacts", [])) >= 1, d
          print("bootstrap launcher selfcheck ok")
          PY

      - name: Launcher selfcheck (relative path args)
        run: |
          set -euo pipefail
          ref="$(git rev-parse --short HEAD)"
          work=/tmp/ralf-launch-relative-args
          rm -rf "$work"
          mkdir -p "$work"
          cp bootstrap/examples/answers.generic_home.yml "$work/answers.yml"
          (
            cd "$work"
            PROVISIONER=host YES=1 APPLY=1 \
              ANSWERS_FILE=answers.yml \
              EXPORT_ANSWERS=exported/answers.out.yml \
              OUTPUTS_DIR=outs \
              RALF_REPO_URL="file://${GITHUB_WORKSPACE}" RALF_REF="$ref" \
              bash "${GITHUB_WORKSPACE}/bootstrap/start.sh" >/dev/null
          )

          python3 - <<'PY'
          import json, os
          base = "/tmp/ralf-launch-relative-args"
          d = json.load(open(base + "/outs/cli_status.json"))
          assert d["status"] == "ok", d
          assert d["outputs_dir"] == base + "/outs", d
          assert os.path.exists(base + "/exported/answers.out.yml")
          print("bootstrap launcher relative path args selfcheck ok")
          PY

      - name: Launcher selfcheck (TUI/non-interactive hint)
        run: |
          set -euo pipefail
          ref="$(git rev-parse --short HEAD)"
          out=/tmp/ralf-launch-tui-ni-hint
          rm -rf "$out"
          TUI=1 NON_INTERACTIVE=1 PROVISIONER=host OUTPUTS_DIR="$out" \
            RALF_REPO_URL="file://${GITHUB_WORKSPACE}" RALF_REF="$ref" \
            bash bootstrap/start.sh >/tmp/ralf-launch-tui-ni-hint.log 2>&1 || true
          grep -q 'TUI requested with NON_INTERACTIVE=1; CLI policy will disable TUI' /tmp/ralf-launch-tui-ni-hint.log

      - name: Launcher selfcheck (tag ref)
        run: |
          set -euo pipefail
          tag="ci-bootstrap-selfcheck-tag"
          git tag -f "$tag" >/dev/null
          trap 'git tag -d "$tag" >/dev/null 2>&1 || true' EXIT
          out=/tmp/ralf-launch-selfcheck-tag
          rm -rf "$out"
          OUTPUTS_DIR="$out" PROVISIONER=host YES=1 APPLY=1 \
            RALF_REPO_URL="file://${GITHUB_WORKSPACE}" RALF_REF="$tag" \
            bash bootstrap/start.sh >/dev/null

          python3 - <<'PY'
          import json
          d = json.load(open("/tmp/ralf-launch-selfcheck-tag/cli_status.json"))
          assert d["status"] == "ok", d
          print("bootstrap launcher tag selfcheck ok")
          PY
