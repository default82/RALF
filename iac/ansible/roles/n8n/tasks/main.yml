---
# n8n Ansible Role - Main Tasks

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install system prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
      - gnupg
      - build-essential
      - python3-pip
    state: present

# Node.js Installation
- name: Check if NodeSource repository exists
  ansible.builtin.stat:
    path: /etc/apt/sources.list.d/nodesource.list
  register: nodesource_repo

- name: Add NodeSource GPG key
  ansible.builtin.apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    state: present
  when: not nodesource_repo.stat.exists

- name: Add NodeSource repository
  ansible.builtin.apt_repository:
    repo: "deb https://deb.nodesource.com/node_{{ nodejs_version }}.x nodistro main"
    state: present
    filename: nodesource
  when: not nodesource_repo.stat.exists

- name: Install Node.js
  ansible.builtin.apt:
    name: nodejs
    state: present
    update_cache: yes

# n8n User
- name: Create n8n system user
  ansible.builtin.user:
    name: "{{ n8n_user }}"
    system: yes
    create_home: yes
    home: "{{ n8n_data_dir }}"
    shell: /bin/bash
    state: present

# n8n Installation
- name: Create n8n directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ n8n_user }}"
    group: "{{ n8n_group }}"
    mode: '0755'
  loop:
    - "{{ n8n_install_dir }}"
    - "{{ n8n_data_dir }}"
    - "{{ n8n_data_dir }}/.n8n"

- name: Check if n8n is installed
  ansible.builtin.command: which n8n
  register: n8n_installed
  failed_when: false
  changed_when: false

- name: Install n8n globally via npm
  community.general.npm:
    name: n8n
    global: yes
    state: "{{ 'latest' if n8n_version == 'latest' else 'present' }}"
    version: "{{ n8n_version if n8n_version != 'latest' else omit }}"
  when: not n8n_installed.rc == 0

- name: Create n8n environment file
  ansible.builtin.template:
    src: n8n.env.j2
    dest: "{{ n8n_data_dir }}/.n8n/env"
    owner: "{{ n8n_user }}"
    group: "{{ n8n_group }}"
    mode: '0600'
  notify: restart n8n

- name: Create n8n systemd service
  ansible.builtin.template:
    src: n8n.service.j2
    dest: /etc/systemd/system/{{ n8n_service_name }}.service
    mode: '0644'
  notify: restart n8n

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable and start n8n service
  ansible.builtin.systemd:
    name: "{{ n8n_service_name }}"
    enabled: yes
    state: started

- name: Wait for n8n to be ready
  ansible.builtin.wait_for:
    port: "{{ n8n_port }}"
    timeout: 60
