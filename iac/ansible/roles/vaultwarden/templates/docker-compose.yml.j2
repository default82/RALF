---
# Vaultwarden Docker Compose Configuration
# Managed by Ansible - Do not edit manually

services:
  vaultwarden:
    image: {{ vaultwarden_docker_image }}:{{ vaultwarden_version }}
    container_name: vaultwarden
    restart: unless-stopped
    ports:
      - "{{ vaultwarden_listen_port }}:80"
    volumes:
      - {{ vaultwarden_data_dir }}:/data
      - /var/log/vaultwarden:/logs
    environment:
      # Domain Configuration
      DOMAIN: "https://{{ vaultwarden_domain }}"

      # Database Configuration
      DATABASE_URL: "{{ vaultwarden_database_url }}"

      # Network Configuration
      ROCKET_ADDRESS: "0.0.0.0"
      ROCKET_PORT: "80"
      ROCKET_WORKERS: "{{ vaultwarden_worker_threads }}"

      # Security Settings
      SIGNUPS_ALLOWED: "{{ vaultwarden_signups_allowed | string | lower }}"
      INVITATIONS_ALLOWED: "{{ vaultwarden_invitations_allowed | string | lower }}"
      SHOW_PASSWORD_HINT: "{{ vaultwarden_show_password_hint | string | lower }}"
      WEB_VAULT_ENABLED: "{{ vaultwarden_web_vault_enabled | string | lower }}"
      ADMIN_TOKEN: "{{ vaultwarden_admin_token }}"

      # Logging
      LOG_LEVEL: "{{ vaultwarden_log_level }}"
      LOG_FILE: "/logs/vaultwarden.log"
      EXTENDED_LOGGING: "{{ vaultwarden_extended_logging | string | lower }}"

      # Performance & Caching
      ICON_CACHE_TTL: "{{ vaultwarden_icon_cache_ttl }}"
      ICON_CACHE_NEGTTL: "{{ vaultwarden_icon_cache_negttl }}"
{% if vaultwarden_smtp_host %}

      # SMTP Configuration
      SMTP_HOST: "{{ vaultwarden_smtp_host }}"
      SMTP_FROM: "{{ vaultwarden_smtp_from }}"
      SMTP_PORT: "{{ vaultwarden_smtp_port }}"
      SMTP_SECURITY: "{{ vaultwarden_smtp_security }}"
{% if vaultwarden_smtp_username %}
      SMTP_USERNAME: "{{ vaultwarden_smtp_username }}"
      SMTP_PASSWORD: "{{ vaultwarden_smtp_password }}"
{% endif %}
{% endif %}

    # Health Check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource Limits (optional)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
