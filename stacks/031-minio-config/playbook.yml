---
- name: Configure MinIO service
  hosts: minio
  become: true
  vars:
    minio_user: minio
    minio_group: minio
    minio_bin: /usr/local/bin/minio
    minio_data_dir: /var/lib/minio
    minio_etc_dir: /etc/minio

    # Diese Datei liegt auf dem Control-Node (CT 10010), nicht auf dem MinIO-Host.
    minio_env_local_path: /opt/ralf/runtime/secrets/minio.env

    # Ziel auf dem MinIO-Host
    minio_env_remote_path: /etc/default/minio

  pre_tasks:
    - name: Assert MinIO env file exists on control node
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ minio_env_local_path }}"
      register: minio_env_stat

    - name: Fail if MinIO env missing on control node
      delegate_to: localhost
      become: false
      ansible.builtin.fail:
        msg: "Missing {{ minio_env_local_path }} on CT 10010. Create it first."
      when: not minio_env_stat.stat.exists

  tasks:
    - name: Install dependencies
      ansible.builtin.apt:
        update_cache: true
        name:
          - ca-certificates
          - curl
        state: present

    - name: Create minio group
      ansible.builtin.group:
        name: "{{ minio_group }}"
        system: true
        state: present

    - name: Create minio user
      ansible.builtin.user:
        name: "{{ minio_user }}"
        group: "{{ minio_group }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: false
        state: present

    - name: Create directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ minio_user }}"
        group: "{{ minio_group }}"
        mode: "0750"
      loop:
        - "{{ minio_data_dir }}"
        - "{{ minio_etc_dir }}"

    - name: Download MinIO server binary
      ansible.builtin.get_url:
        url: "https://dl.min.io/server/minio/release/linux-amd64/minio"
        dest: "{{ minio_bin }}"
        mode: "0755"
      register: minio_download

    - name: Upload MinIO env file to target
      ansible.builtin.copy:
        src: "{{ minio_env_local_path }}"
        dest: "{{ minio_env_remote_path }}"
        owner: root
        group: root
        mode: "0600"
      notify: restart minio

    - name: Install systemd unit
      ansible.builtin.copy:
        dest: /etc/systemd/system/minio.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=MinIO
          Wants=network-online.target
          After=network-online.target

          [Service]
          EnvironmentFile={{ minio_env_remote_path }}
          ExecStart={{ minio_bin }} server ${MINIO_VOLUMES} --console-address ${MINIO_CONSOLE_ADDRESS}
          Restart=always
          LimitNOFILE=65536
          User={{ minio_user }}
          Group={{ minio_group }}

          # Hardening (light)
          PrivateTmp=true
          ProtectSystem=full
          ProtectHome=true
          NoNewPrivileges=true

          [Install]
          WantedBy=multi-user.target
      notify: restart minio

    - name: Ensure MinIO is enabled and started
      ansible.builtin.systemd:
        name: minio.service
        enabled: true
        state: started
        daemon_reload: true

    - name: Wait for MinIO health endpoint
      ansible.builtin.uri:
        url: "http://127.0.0.1:9000/minio/health/live"
        method: GET
        status_code: 200
      register: health
      retries: 30
      delay: 2
      until: health.status == 200

  handlers:
    - name: restart minio
      ansible.builtin.systemd:
        name: minio.service
        state: restarted
        daemon_reload: true
