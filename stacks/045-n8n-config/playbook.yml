---
- name: Configure n8n (PostgreSQL backend)
  hosts: n8n
  become: true
  vars:
    n8n_env_path: /opt/ralf/runtime/secrets/n8n.env
    pg_env_path: /opt/ralf/runtime/secrets/postgres.env
    synapse_env_path: /opt/ralf/runtime/secrets/synapse.env
    n8n_user: n8n
    n8n_group: n8n
    n8n_data_dir: /var/lib/n8n
    n8n_cfg_dir: /etc/n8n
    n8n_env_file: /etc/n8n/n8n.env
    n8n_tls_dir: /etc/n8n/tls
    n8n_tls_cert: /etc/n8n/tls/fullchain.pem
    n8n_tls_key: /etc/n8n/tls/privkey.pem
    n8n_bin: /usr/bin/n8n

  pre_tasks:
    - name: Assert env files exist on control node
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ n8n_env_path }}"
        - "{{ pg_env_path }}"
        - "{{ synapse_env_path }}"
      register: n8n_env_stats

    - name: Fail if env files missing on control node
      delegate_to: localhost
      become: false
      ansible.builtin.fail:
        msg: "Missing {{ item.stat.path }} on CT 10010. Create it first."
      loop: "{{ n8n_env_stats.results }}"
      when: not item.stat.exists

    - name: Load env files from control node
      delegate_to: localhost
      become: false
      ansible.builtin.slurp:
        src: "{{ item.src }}"
      loop:
        - { key: n8n, src: "{{ n8n_env_path }}" }
        - { key: postgres, src: "{{ pg_env_path }}" }
        - { key: synapse, src: "{{ synapse_env_path }}" }
      register: n8n_env_raw

    - name: Parse env line arrays
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        n8n_env_lines: "{{ (n8n_env_raw.results[0].content | b64decode).splitlines() }}"
        pg_env_lines: "{{ (n8n_env_raw.results[1].content | b64decode).splitlines() }}"
        synapse_env_lines: "{{ (n8n_env_raw.results[2].content | b64decode).splitlines() }}"

    - name: Build n8n env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        n8n_env: "{{ n8n_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ n8n_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

    - name: Build postgres env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        pg_env: "{{ pg_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ pg_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

    - name: Build synapse env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        synapse_env: "{{ synapse_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ synapse_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

  tasks:
    - name: Install base packages
      ansible.builtin.apt:
        update_cache: true
        name:
          - ca-certificates
          - curl
          - gnupg
          - openssl
          - nginx
        state: present

    - name: Ensure apt keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Install NodeSource keyring
      ansible.builtin.shell: |
        set -euo pipefail
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key \
          | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
      args:
        executable: /bin/bash
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Add NodeSource apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main"
        filename: nodesource
        state: present

    - name: Install Node.js runtime
      ansible.builtin.apt:
        update_cache: true
        name:
          - nodejs
        state: present

    - name: Ensure n8n group exists
      ansible.builtin.group:
        name: "{{ n8n_group }}"
        system: true
        state: present

    - name: Ensure n8n user exists
      ansible.builtin.user:
        name: "{{ n8n_user }}"
        group: "{{ n8n_group }}"
        system: true
        shell: /usr/sbin/nologin
        home: "{{ n8n_data_dir }}"
        create_home: false
        state: present

    - name: Ensure n8n directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ n8n_data_dir }}", owner: "{{ n8n_user }}", group: "{{ n8n_group }}", mode: "0750" }
        - { path: "{{ n8n_cfg_dir }}", owner: root, group: root, mode: "0755" }
        - { path: "{{ n8n_tls_dir }}", owner: root, group: root, mode: "0750" }

    - name: Install n8n globally with npm
      ansible.builtin.command:
        cmd: npm install -g --no-audit --no-fund n8n
      args:
        creates: "{{ n8n_bin }}"

    - name: Generate self-signed certificate for n8n
      ansible.builtin.command:
        cmd: >-
          openssl req -x509 -nodes -newkey rsa:2048
          -keyout {{ n8n_tls_key }}
          -out {{ n8n_tls_cert }}
          -days 3650
          -subj /CN={{ n8n_env.N8N_HOSTNAME }}
      args:
        creates: "{{ n8n_tls_key }}"

    - name: Set n8n TLS key permissions
      ansible.builtin.file:
        path: "{{ n8n_tls_key }}"
        owner: root
        group: root
        mode: "0600"

    - name: Render n8n environment file
      ansible.builtin.copy:
        dest: "{{ n8n_env_file }}"
        owner: root
        group: "{{ n8n_group }}"
        mode: "0640"
        content: |
          NODE_ENV=production
          N8N_HOST={{ n8n_env.N8N_HOSTNAME }}
          N8N_PORT={{ n8n_env.N8N_PORT }}
          N8N_PROTOCOL=http
          N8N_LISTEN_ADDRESS=127.0.0.1
          N8N_EDITOR_BASE_URL={{ n8n_env.N8N_PROTOCOL }}://{{ n8n_env.N8N_HOSTNAME }}/
          WEBHOOK_URL={{ n8n_env.N8N_PROTOCOL }}://{{ n8n_env.N8N_HOSTNAME }}/
          N8N_PROXY_HOPS=1
          N8N_SECURE_COOKIE=true
          N8N_ENCRYPTION_KEY={{ n8n_env.N8N_ENCRYPTION_KEY }}
          N8N_USER_FOLDER={{ n8n_data_dir }}
          N8N_DIAGNOSTICS_ENABLED=false
          N8N_PERSONALIZATION_ENABLED=false
          N8N_VERSION_NOTIFICATIONS_ENABLED=false
          N8N_TEMPLATES_ENABLED=false
          N8N_BASIC_AUTH_ACTIVE=true
          N8N_BASIC_AUTH_USER={{ n8n_env.N8N_BASIC_AUTH_USER }}
          N8N_BASIC_AUTH_PASSWORD={{ n8n_env.N8N_BASIC_AUTH_PASSWORD }}
          DB_TYPE=postgresdb
          DB_POSTGRESDB_HOST={{ n8n_env.N8N_DB_HOST }}
          DB_POSTGRESDB_PORT={{ n8n_env.N8N_DB_PORT }}
          DB_POSTGRESDB_DATABASE={{ pg_env.N8N_DB_NAME }}
          DB_POSTGRESDB_USER={{ pg_env.N8N_DB_USER }}
          DB_POSTGRESDB_PASSWORD={{ pg_env.N8N_DB_PASSWORD }}
          DB_POSTGRESDB_SCHEMA=public
      notify: restart n8n

    - name: Create n8n systemd unit
      ansible.builtin.copy:
        dest: /etc/systemd/system/n8n.service
        owner: root
        group: root
        mode: "0644"
        content: |
          [Unit]
          Description=n8n workflow automation
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          User={{ n8n_user }}
          Group={{ n8n_group }}
          Environment=HOME={{ n8n_data_dir }}
          EnvironmentFile={{ n8n_env_file }}
          WorkingDirectory={{ n8n_data_dir }}
          ExecStart={{ n8n_bin }} start
          Restart=always
          RestartSec=5

          [Install]
          WantedBy=multi-user.target
      notify: restart n8n

    - name: Configure nginx TLS reverse proxy for n8n
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/n8n.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          map $http_upgrade $connection_upgrade {
            default upgrade;
            '' close;
          }

          server {
            listen 443 ssl;
            server_name {{ n8n_env.N8N_HOSTNAME }};

            ssl_certificate {{ n8n_tls_cert }};
            ssl_certificate_key {{ n8n_tls_key }};

            location / {
              proxy_pass http://127.0.0.1:{{ n8n_env.N8N_PORT }};
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
              proxy_set_header X-Forwarded-Host $host;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection $connection_upgrade;
            }
          }
      notify: restart nginx

    - name: Enable n8n nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/n8n.conf
        dest: /etc/nginx/sites-enabled/n8n.conf
        state: link
      notify: restart nginx

    - name: Disable default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Ensure services are enabled and started
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - n8n
        - nginx

    - name: Ensure workflow seed directory exists
      ansible.builtin.file:
        path: "{{ n8n_data_dir }}/seed-workflows"
        state: directory
        owner: "{{ n8n_user }}"
        group: "{{ n8n_group }}"
        mode: "0750"

    - name: Render RALF n8n workflow seeds on target
      ansible.builtin.copy:
        dest: "{{ n8n_data_dir }}/seed-workflows/{{ item.dest }}"
        owner: "{{ n8n_user }}"
        group: "{{ n8n_group }}"
        mode: "0640"
        content: >-
          {{
            lookup('ansible.builtin.file', item.src)
            | replace('REPLACE_WITH_RALF_PASSWORD', synapse_env.SYNAPSE_ADMIN_PASSWORD_RALF | default(''))
          }}
      loop:
        - { src: "{{ playbook_dir }}/../../bootstrap/examples/n8n-matrix-create-rooms-and-ping.json", dest: "n8n-matrix-create-rooms-and-ping.json" }
        - { src: "{{ playbook_dir }}/../../bootstrap/examples/n8n-matrix-exo-ping-pong-room.json", dest: "n8n-matrix-exo-ping-pong-room.json" }

    - name: List existing n8n workflows
      ansible.builtin.shell: |
        set -euo pipefail
        export HOME={{ n8n_data_dir }}
        export N8N_USER_FOLDER={{ n8n_data_dir }}
        set -a
        source {{ n8n_env_file }}
        set +a
        su -s /bin/bash -c 'n8n list:workflow || true' {{ n8n_user }}
      args:
        executable: /bin/bash
      register: n8n_workflow_list
      changed_when: false

    - name: Import seed workflow if missing
      ansible.builtin.shell: |
        set -euo pipefail
        export HOME={{ n8n_data_dir }}
        export N8N_USER_FOLDER={{ n8n_data_dir }}
        set -a
        source {{ n8n_env_file }}
        set +a
        su -s /bin/bash -c 'n8n import:workflow --input={{ n8n_data_dir }}/seed-workflows/{{ item.file }}' {{ n8n_user }}
      args:
        executable: /bin/bash
      loop:
        - { name: "RALF Matrix - Create Rooms and Ping", file: "n8n-matrix-create-rooms-and-ping.json" }
        - { name: "RALF Matrix EXO Ping Pong (Room Poll)", file: "n8n-matrix-exo-ping-pong-room.json" }
      when: item.name not in (n8n_workflow_list.stdout | default(''))
      register: n8n_seed_imports
      changed_when: true

  handlers:
    - name: restart n8n
      ansible.builtin.systemd:
        name: n8n
        state: restarted
        daemon_reload: true

    - name: restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
