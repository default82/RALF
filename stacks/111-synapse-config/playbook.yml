---
- name: Configure Matrix Synapse
  hosts: synapse
  become: true
  vars:
    synapse_env_path: /opt/ralf/runtime/secrets/synapse.env
    synapse_conf_path: /etc/matrix-synapse/homeserver.yaml
    synapse_signing_key_path: /etc/matrix-synapse/homeserver.signing.key
    synapse_tls_dir: /etc/matrix-synapse/tls
    synapse_tls_cert_path: /etc/matrix-synapse/tls/synapse.crt
    synapse_tls_key_path: /etc/matrix-synapse/tls/synapse.key
    synapse_element_root: /opt/element-web
    synapse_element_current: /opt/element-web/current
    synapse_element_tarball: /tmp/element-web.tar.gz
    synapse_element_config_path: /opt/element-web/current/config.json
    synapse_webclient_host: synapse.homelab.lan

  pre_tasks:
    - name: Assert synapse env file exists on control node
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ synapse_env_path }}"
      register: syn_env_stat

    - name: Fail if synapse env missing on control node
      delegate_to: localhost
      become: false
      ansible.builtin.fail:
        msg: "Missing {{ synapse_env_path }} on CT 10010. Create it first."
      when: not syn_env_stat.stat.exists

    - name: Load synapse env from control node
      delegate_to: localhost
      become: false
      ansible.builtin.slurp:
        src: "{{ synapse_env_path }}"
      register: syn_env_raw

    - name: Parse synapse env
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        syn_env_lines: "{{ (syn_env_raw.content | b64decode).splitlines() }}"

    - name: Build synapse env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        syn_env: "{{ syn_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ syn_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

  tasks:
    - name: Resolve latest Element Web release version (control node)
      delegate_to: localhost
      become: false
      ansible.builtin.uri:
        url: https://api.github.com/repos/element-hq/element-web/releases/latest
        return_content: true
      register: element_release_api
      changed_when: false

    - name: Set Element Web version facts
      ansible.builtin.set_fact:
        element_web_tag: "{{ element_release_api.json.tag_name | default('v1.11.0') }}"

    - name: Install dependencies
      ansible.builtin.apt:
        update_cache: true
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - nginx
          - openssl
          - tar
        state: present

    - name: Add Matrix.org repository key
      ansible.builtin.get_url:
        url: https://packages.matrix.org/debian/matrix-org-archive-keyring.gpg
        dest: /usr/share/keyrings/matrix-org-archive-keyring.gpg
        mode: "0644"

    - name: Add Matrix.org apt repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/matrix-org-archive-keyring.gpg] https://packages.matrix.org/debian/ {{ ansible_distribution_release }} main"
        filename: matrix-org
        state: present

    - name: Preseed Synapse debconf
      ansible.builtin.debconf:
        name: matrix-synapse
        question: "{{ item.question }}"
        value: "{{ item.value }}"
        vtype: "{{ item.vtype }}"
      loop:
        - { question: "matrix-synapse/server-name", value: "{{ syn_env.SYNAPSE_SERVER_NAME }}", vtype: "string" }
        - { question: "matrix-synapse/report-stats", value: "{{ syn_env.SYNAPSE_REPORT_STATS }}", vtype: "boolean" }

    - name: Install Matrix Synapse
      ansible.builtin.apt:
        update_cache: true
        name:
          - matrix-synapse-py3
        state: present

    - name: Ensure Synapse signing key exists
      ansible.builtin.command:
        cmd: "python3 -m synapse.app.homeserver --generate-keys -c {{ synapse_conf_path }}"
      args:
        creates: "{{ synapse_signing_key_path }}"

    - name: Render Synapse config
      ansible.builtin.copy:
        dest: "{{ synapse_conf_path }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          server_name: "{{ syn_env.SYNAPSE_SERVER_NAME }}"
          public_baseurl: "{{ syn_env.SYNAPSE_PUBLIC_BASEURL }}"
          pid_file: /var/run/matrix-synapse.pid

          listeners:
            - port: {{ syn_env.SYNAPSE_LISTEN_PORT | int }}
              tls: false
              type: http
              x_forwarded: true
              resources:
                - names: [client, federation]
                  compress: false

          database:
            name: psycopg2
            args:
              user: "{{ syn_env.SYNAPSE_DB_USER }}"
              password: "{{ syn_env.SYNAPSE_DB_PASSWORD }}"
              database: "{{ syn_env.SYNAPSE_DB_NAME }}"
              host: "{{ syn_env.SYNAPSE_DB_HOST }}"
              port: {{ syn_env.SYNAPSE_DB_PORT | int }}

          registration_shared_secret: "{{ syn_env.SYNAPSE_REGISTRATION_SHARED_SECRET }}"
          macaroon_secret_key: "{{ syn_env.SYNAPSE_MACAROON_SECRET_KEY }}"
          form_secret: "{{ syn_env.SYNAPSE_FORM_SECRET }}"

          enable_registration: {{ syn_env.SYNAPSE_ENABLE_REGISTRATION | lower }}
          report_stats: {{ syn_env.SYNAPSE_REPORT_STATS | lower }}
          signing_key_path: "{{ synapse_signing_key_path }}"

          email:
            smtp_host: "{{ syn_env.SYNAPSE_SMTP_HOST }}"
            smtp_port: {{ syn_env.SYNAPSE_SMTP_PORT | int }}
            smtp_user: "{{ syn_env.SYNAPSE_SMTP_USER }}"
            smtp_pass: "{{ syn_env.SYNAPSE_SMTP_PASSWORD }}"
            notif_from: "{{ syn_env.SYNAPSE_SMTP_FROM }}"

      notify: restart synapse

    - name: Ensure Synapse is enabled and started
      ansible.builtin.service:
        name: matrix-synapse
        state: started
        enabled: true

    - name: Restart Synapse before user bootstrap (ensures shared-secret config is active)
      ansible.builtin.service:
        name: matrix-synapse
        state: restarted
      changed_when: false

    - name: Wait for Synapse HTTP listener
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ syn_env.SYNAPSE_LISTEN_PORT | int }}"
        delay: 1
        timeout: 30
      changed_when: false

    - name: Create admin users (ralf, kolja)
      ansible.builtin.command:
        cmd: "register_new_matrix_user -c {{ synapse_conf_path }} http://localhost:{{ syn_env.SYNAPSE_LISTEN_PORT }} --admin --user {{ item.user }} --password {{ item.pass }} --exists-ok"
      loop:
        - { user: "ralf", pass: "{{ syn_env.SYNAPSE_ADMIN_PASSWORD_RALF }}" }
        - { user: "kolja", pass: "{{ syn_env.SYNAPSE_ADMIN_PASSWORD_KOLJA }}" }
      changed_when: false
      failed_when:
        - create_admin_users.rc != 0
        - "'User ID already taken.' not in (create_admin_users.stdout | default(''))"
      register: create_admin_users

    - name: Ensure Element Web directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: root
        group: root
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ synapse_element_root }}", mode: "0755" }
        - { path: "{{ synapse_tls_dir }}", mode: "0750" }

    - name: Download Element Web release tarball
      ansible.builtin.get_url:
        url: "https://github.com/element-hq/element-web/releases/download/{{ element_web_tag }}/element-{{ element_web_tag }}.tar.gz"
        dest: "{{ synapse_element_tarball }}"
        mode: "0644"
        force: false
      register: element_tarball_download

    - name: Extract Element Web release
      ansible.builtin.unarchive:
        src: "{{ synapse_element_tarball }}"
        dest: "{{ synapse_element_root }}"
        remote_src: true
        creates: "{{ synapse_element_root }}/element-{{ element_web_tag }}"

    - name: Update Element Web current symlink
      ansible.builtin.file:
        src: "{{ synapse_element_root }}/element-{{ element_web_tag }}"
        dest: "{{ synapse_element_current }}"
        state: link
        force: true

    - name: Render Element Web config.json
      ansible.builtin.copy:
        dest: "{{ synapse_element_config_path }}"
        owner: root
        group: root
        mode: "0644"
        content: |
          {
            "default_server_config": {
              "m.homeserver": {
                "base_url": "{{ syn_env.SYNAPSE_PUBLIC_BASEURL }}",
                "server_name": "{{ syn_env.SYNAPSE_SERVER_NAME }}"
              }
            },
            "default_server_name": "{{ syn_env.SYNAPSE_SERVER_NAME }}",
            "brand": "RALF Matrix"
          }
      notify: restart nginx

    - name: Generate self-signed certificate for Synapse web client
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -newkey rsa:2048
          -keyout {{ synapse_tls_key_path }}
          -out {{ synapse_tls_cert_path }}
          -days 3650
          -subj /CN={{ synapse_webclient_host }}
      args:
        creates: "{{ synapse_tls_cert_path }}"

    - name: Set Synapse TLS key permissions
      ansible.builtin.file:
        path: "{{ synapse_tls_key_path }}"
        owner: root
        group: root
        mode: "0600"

    - name: Configure nginx TLS reverse proxy and Element Web for Synapse
      ansible.builtin.copy:
        dest: /etc/nginx/sites-available/synapse
        owner: root
        group: root
        mode: "0644"
        content: |
          server {
            listen 443 ssl;
            server_name {{ synapse_webclient_host }};

            ssl_certificate {{ synapse_tls_cert_path }};
            ssl_certificate_key {{ synapse_tls_key_path }};

            root {{ synapse_element_current }};
            index index.html;

            location /_matrix/ {
              proxy_pass http://127.0.0.1:{{ syn_env.SYNAPSE_LISTEN_PORT }};
              proxy_set_header Host $host;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
            }

            location /_synapse/client/ {
              proxy_pass http://127.0.0.1:{{ syn_env.SYNAPSE_LISTEN_PORT }};
              proxy_set_header Host $host;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto https;
            }

            location / {
              try_files $uri $uri/ /index.html;
            }
          }
      notify: restart nginx

    - name: Enable synapse nginx site
      ansible.builtin.file:
        src: /etc/nginx/sites-available/synapse
        dest: /etc/nginx/sites-enabled/synapse
        state: link
      notify: restart nginx

    - name: Disable default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Ensure nginx is enabled and started
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

    - name: Flush nginx handler before web client check
      ansible.builtin.meta: flush_handlers

    - name: Wait for Synapse web client HTTPS listener
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: 443
        delay: 1
        timeout: 30
      changed_when: false

  handlers:
    - name: restart synapse
      ansible.builtin.service:
        name: matrix-synapse
        state: restarted
    - name: restart nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
