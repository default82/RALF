---
- name: Configure internal mail stack (Postfix + Dovecot + PostgreSQL)
  hosts: mail
  become: true
  vars:
    mail_env_path: /opt/ralf/runtime/secrets/mail.env
    pg_env_path: /opt/ralf/runtime/secrets/postgres.env
    vmail_uid: 5000
    vmail_gid: 5000
    vmail_home: /var/mail/vhosts
    tls_dir: /etc/ssl/homelab-mail
    tls_cert: /etc/ssl/homelab-mail/fullchain.pem
    tls_key: /etc/ssl/homelab-mail/privkey.pem

  pre_tasks:
    - name: Assert required env files exist on control node
      delegate_to: localhost
      become: false
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ mail_env_path }}"
        - "{{ pg_env_path }}"
      register: env_stats

    - name: Fail if required env files are missing
      delegate_to: localhost
      become: false
      ansible.builtin.fail:
        msg: "Missing {{ item.stat.path }} on CT 10010. Create it first."
      loop: "{{ env_stats.results }}"
      when: not item.stat.exists

    - name: Load mail env from control node
      delegate_to: localhost
      become: false
      ansible.builtin.slurp:
        src: "{{ mail_env_path }}"
      register: mail_env_raw

    - name: Load postgres env from control node
      delegate_to: localhost
      become: false
      ansible.builtin.slurp:
        src: "{{ pg_env_path }}"
      register: pg_env_raw

    - name: Parse env files
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        mail_env_lines: "{{ (mail_env_raw.content | b64decode).splitlines() }}"
        pg_env_lines: "{{ (pg_env_raw.content | b64decode).splitlines() }}"

    - name: Build mail env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        mail_env: "{{ mail_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ mail_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

    - name: Build postgres env dict
      delegate_to: localhost
      become: false
      ansible.builtin.set_fact:
        pg_env: "{{ pg_env | default({}) | combine({ (item.split('=', 1)[0]): (item.split('=', 1)[1]) }) }}"
      loop: "{{ pg_env_lines }}"
      when: item | length > 0 and not item.startswith('#')

  tasks:
    - name: Install mail packages
      ansible.builtin.apt:
        update_cache: true
        name:
          - postfix
          - postfix-pgsql
          - dovecot-core
          - dovecot-imapd
          - dovecot-lmtpd
          - dovecot-pgsql
          - openssl
        state: present

    - name: Ensure vmail group exists
      ansible.builtin.group:
        name: vmail
        gid: "{{ vmail_gid }}"
        system: true
        state: present

    - name: Ensure vmail user exists
      ansible.builtin.user:
        name: vmail
        uid: "{{ vmail_uid }}"
        group: vmail
        system: true
        shell: /usr/sbin/nologin
        create_home: false
        state: present

    - name: Ensure mail storage directories exist
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { path: "{{ vmail_home }}", owner: vmail, group: vmail, mode: "0750" }
        - { path: "{{ vmail_home }}/{{ mail_env.MAIL_DOMAIN }}", owner: vmail, group: vmail, mode: "0750" }
        - { path: "{{ tls_dir }}", owner: root, group: root, mode: "0750" }

    - name: Generate self-signed TLS cert for internal mail
      ansible.builtin.command:
        cmd: >-
          openssl req -x509 -nodes -newkey rsa:2048
          -keyout {{ tls_key }}
          -out {{ tls_cert }}
          -days 3650
          -subj /CN={{ mail_env.MAIL_HOSTNAME }}
      args:
        creates: "{{ tls_key }}"

    - name: Set TLS key permissions
      ansible.builtin.file:
        path: "{{ tls_key }}"
        owner: root
        group: root
        mode: "0600"

    - name: Write Postfix pgsql domain map
      ansible.builtin.copy:
        dest: /etc/postfix/pgsql-virtual-mailbox-domains.cf
        owner: root
        group: root
        mode: "0600"
        content: |
          user = {{ pg_env.MAIL_DB_USER }}
          password = {{ pg_env.MAIL_DB_PASSWORD }}
          hosts = 10.10.20.10
          dbname = {{ pg_env.MAIL_DB_NAME }}
          query = SELECT 1 FROM virtual_domains WHERE name='%s'
      notify: restart postfix

    - name: Write Postfix pgsql mailbox map
      ansible.builtin.copy:
        dest: /etc/postfix/pgsql-virtual-mailbox-maps.cf
        owner: root
        group: root
        mode: "0600"
        content: |
          user = {{ pg_env.MAIL_DB_USER }}
          password = {{ pg_env.MAIL_DB_PASSWORD }}
          hosts = 10.10.20.10
          dbname = {{ pg_env.MAIL_DB_NAME }}
          query = SELECT CONCAT('{{ vmail_home }}/', split_part(email,'@',2), '/', split_part(email,'@',1), '/') FROM virtual_users WHERE email='%s' AND active=true
      notify: restart postfix

    - name: Write Postfix pgsql recipient map
      ansible.builtin.copy:
        dest: /etc/postfix/pgsql-virtual-alias-maps.cf
        owner: root
        group: root
        mode: "0600"
        content: |
          user = {{ pg_env.MAIL_DB_USER }}
          password = {{ pg_env.MAIL_DB_PASSWORD }}
          hosts = 10.10.20.10
          dbname = {{ pg_env.MAIL_DB_NAME }}
          query = SELECT email FROM virtual_users WHERE email='%s' AND active=true
      notify: restart postfix

    - name: Configure Postfix main.cf
      ansible.builtin.copy:
        dest: /etc/postfix/main.cf
        owner: root
        group: root
        mode: "0644"
        content: |
          compatibility_level = 3.6
          myhostname = {{ mail_env.MAIL_HOSTNAME }}
          myorigin = $myhostname
          mydestination = localhost
          inet_interfaces = all
          inet_protocols = all

          smtpd_banner = $myhostname ESMTP
          biff = no
          append_dot_mydomain = no
          readme_directory = no

          smtpd_tls_cert_file = {{ tls_cert }}
          smtpd_tls_key_file = {{ tls_key }}
          smtpd_tls_security_level = may
          smtpd_tls_auth_only = yes
          smtp_tls_security_level = may

          virtual_mailbox_domains = proxy:pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf
          virtual_mailbox_maps = proxy:pgsql:/etc/postfix/pgsql-virtual-mailbox-maps.cf
          virtual_alias_maps = proxy:pgsql:/etc/postfix/pgsql-virtual-alias-maps.cf
          virtual_uid_maps = static:{{ vmail_uid }}
          virtual_gid_maps = static:{{ vmail_gid }}
          virtual_mailbox_base = {{ vmail_home }}
          virtual_transport = lmtp:unix:private/dovecot-lmtp

          smtpd_sasl_type = dovecot
          smtpd_sasl_path = private/auth
          smtpd_sasl_auth_enable = yes
          smtpd_recipient_restrictions =
            permit_mynetworks,
            permit_sasl_authenticated,
            reject_unauth_destination

          mailbox_size_limit = 0
          recipient_delimiter = +
      notify: restart postfix

    - name: Enable submission service in Postfix master.cf
      ansible.builtin.blockinfile:
        path: /etc/postfix/master.cf
        marker: "# {mark} RALF submission"
        block: |
          submission inet n       -       y       -       -       smtpd
            -o syslog_name=postfix/submission
            -o smtpd_tls_security_level=encrypt
            -o smtpd_sasl_auth_enable=yes
            -o smtpd_tls_auth_only=yes
            -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
      notify: restart postfix

    - name: Configure Dovecot mail settings
      ansible.builtin.copy:
        dest: /etc/dovecot/conf.d/10-mail.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          mail_location = maildir:{{ vmail_home }}/%d/%n
          namespace inbox {
            inbox = yes
            mailbox Drafts {
              special_use = \Drafts
              auto = create
            }
            mailbox Junk {
              special_use = \Junk
              auto = create
            }
            mailbox Sent {
              special_use = \Sent
              auto = create
            }
            mailbox Trash {
              special_use = \Trash
              auto = create
            }
          }
          first_valid_uid = {{ vmail_uid }}
          last_valid_uid = {{ vmail_uid }}
      notify: restart dovecot

    - name: Configure Dovecot auth
      ansible.builtin.copy:
        dest: /etc/dovecot/conf.d/10-auth.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          disable_plaintext_auth = yes
          auth_mechanisms = plain login
          !include auth-sql.conf.ext
      notify: restart dovecot

    - name: Configure Dovecot master sockets and LMTP
      ansible.builtin.copy:
        dest: /etc/dovecot/conf.d/10-master.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          service lmtp {
            unix_listener /var/spool/postfix/private/dovecot-lmtp {
              mode = 0600
              user = postfix
              group = postfix
            }
          }

          service auth {
            unix_listener /var/spool/postfix/private/auth {
              mode = 0660
              user = postfix
              group = postfix
            }
            unix_listener auth-userdb {
              mode = 0600
              user = vmail
              group = vmail
            }
            user = dovecot
          }

          service auth-worker {
            user = root
          }
      notify: restart dovecot

    - name: Configure Dovecot SSL
      ansible.builtin.copy:
        dest: /etc/dovecot/conf.d/10-ssl.conf
        owner: root
        group: root
        mode: "0644"
        content: |
          ssl = required
          ssl_cert = <{{ tls_cert }}
          ssl_key = <{{ tls_key }}
      notify: restart dovecot

    - name: Configure Dovecot SQL backend
      ansible.builtin.copy:
        dest: /etc/dovecot/dovecot-sql.conf.ext
        owner: root
        group: dovecot
        mode: "0640"
        content: |
          driver = pgsql
          connect = host=10.10.20.10 dbname={{ pg_env.MAIL_DB_NAME }} user={{ pg_env.MAIL_DB_USER }} password={{ pg_env.MAIL_DB_PASSWORD }}
          default_pass_scheme = SHA512-CRYPT
          password_query = SELECT email as user, password FROM virtual_users WHERE email='%u' AND active = true
          user_query = SELECT '{{ vmail_uid }}' AS uid, '{{ vmail_gid }}' AS gid, '{{ vmail_home }}/%d/%n' AS home, 'maildir:{{ vmail_home }}/%d/%n' AS mail
      notify: restart dovecot

    - name: Enable mail services
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - postfix
        - dovecot

  handlers:
    - name: restart postfix
      ansible.builtin.service:
        name: postfix
        state: restarted

    - name: restart dovecot
      ansible.builtin.service:
        name: dovecot
        state: restarted
